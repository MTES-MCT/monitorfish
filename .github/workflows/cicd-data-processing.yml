name: CI/CD data processing pipeline

on:
  push:
    paths:
    - 'datascience/**'
    - '.github/workflows/*'
    - 'infra/docker/Dockerfile.DataPipeline'

jobs:
  build:
    name: Build & test docker image
    runs-on: ubuntu-18.04
    steps:
    
    - name: Checkout
      uses: actions/checkout@v2    

    - name: Get last release version
      id: lastrelease
      uses: pozetroninc/github-action-get-latest-release@master
      with:
        repository: mtes-mct/monitorfish

    - name: Set ENV_PROFILE as PROD when it is a release
      if: startsWith(github.ref, 'refs/tags/v')
      run: echo "ENV_PROFILE=prod" >> $GITHUB_ENV

    - name: Set VERSION
      run: |
        if [ "${ENV_PROFILE}" != "prod" ]; then\
            echo "VERSION=${{ steps.lastrelease.outputs.release }}_snapshot" >> $GITHUB_ENV
        else\
            echo "VERSION=${{ steps.lastrelease.outputs.release }}" >> $GITHUB_ENV
        fi

    - name: Set PUSH
      run : |
        if [[ ${{ github.ref }} == refs/heads/master || ${{ github.ref }} == 'refs/tags/v'* ]]; then\
            echo "PUSH=true" >> $GITHUB_ENV
        else\
            echo "PUSH=false" >> $GITHUB_ENV
        fi

    - name: Set tags
      run : |
        if [[ ${{ github.ref }} == refs/heads/master || ${{ github.ref }} == 'refs/tags/v'* ]]; then\
            echo "TAGS=[]" >> $GITHUB_ENV
        else\
            echo "PUSH=false" >> $GITHUB_ENV
        fi

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@master

    - name: Cache Docker layers
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-single-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-single-buildx


    - name: Build local image
      uses: docker/build-push-action@v2
      with:
        context: .
        builder: ${{ steps.buildx.outputs.name }}
        file: infra/docker/Dockerfile.DataPipeline
        push: true
        tags: localhost:5000/monitorfish-pipeline:${{ env.VERSION }}
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new

    - name: Build production image
      uses: docker/build-push-action@v2
      with:
        context: .
        builder: ${{ steps.buildx.outputs.name }}
        file: infra/docker/Dockerfile.DataPipeline
        push: ${{ env.PUSH }}
        tags: mtes-mct/monitorfish/monitorfish-pipeline:${{ env.VERSION }}
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new

      # Temp fix
      # https://github.com/docker/build-push-action/issues/252
      # https://github.com/moby/buildkit/issues/1896
    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache
                
    - name: Test docker image
      run: make docker-test-pipeline
