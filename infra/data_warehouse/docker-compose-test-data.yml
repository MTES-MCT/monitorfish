version: '3'
services:

  monitorfish-db:
    image: timescale/timescaledb-postgis:1.7.4-pg11
    container_name: monitorfish_database
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=monitorfish_test_db
    volumes:
      - monitorfish-db-data:/var/lib/postgresql/data
    ports:
      - 5432:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 1s
      timeout: 1s
      retries: 30

  monitorfish-flyway:
    image: flyway/flyway
    container_name: monitorfish_flyway
    command: migrate -password=postgres -schemas=public -user=postgres -url=jdbc:postgresql://monitorfish-db:5432/monitorfish_test_db
    volumes:
      - ../../data_warehouse/tests/test_data/external/monitorfish/backend/src/main/resources/db/migration:/flyway/sql/schema
      - ../../data_warehouse/tests/test_data/external/monitorfish/datascience/tests/test_data/remote_database/:/flyway/sql/test_data
    depends_on:
      monitorfish-db:
        condition: service_healthy

volumes:
  monitorfish-db-data:
    driver: local
